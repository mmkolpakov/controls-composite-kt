import kotlin.time.Instant;
import space.kscience.controls.core.CorrelationId;
import space.kscience.controls.composite.old.messages.DeviceMessage;

-- The primary table for storing all device messages.
CREATE TABLE audit_log (
  id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,
  timestamp INTEGER AS Instant NOT NULL,
  source_device_hub TEXT NOT NULL,
  source_device_name TEXT NOT NULL,
  target_device_hub TEXT,
  target_device_name TEXT,
  message_type TEXT NOT NULL,
  correlation_id TEXT AS CorrelationId,
  payload TEXT AS DeviceMessage NOT NULL
);

-- Index on timestamp for efficient time-range queries.
CREATE INDEX audit_log_timestamp_idx ON audit_log(timestamp);

-- Index on correlation_id for tracing specific operations.
CREATE INDEX audit_log_correlation_id_idx ON audit_log(correlation_id);

-- Composite index on the source device for fast filtering by device.
CREATE INDEX audit_log_source_device_idx ON audit_log(source_device_hub, source_device_name);

-- Index on message type for filtering by event type.
CREATE INDEX audit_log_message_type_idx ON audit_log(message_type);

-- Inserts a new audit log entry into the database.
insert_audit_log:
INSERT INTO audit_log(
  timestamp,
  source_device_hub,
  source_device_name,
  target_device_hub,
  target_device_name,
  message_type,
  correlation_id,
  payload
) VALUES (?, ?, ?, ?, ?, ?, ?, ?);

select_payload_audit_log:
SELECT payload FROM audit_log
WHERE timestamp >= :startTime AND timestamp <= :endTime
  AND source_device_name LIKE coalesce(:deviceNamePattern, '%')
  AND (:messageType IS NULL OR message_type = :messageType)
  AND (:correlationId IS NULL OR correlation_id = :correlationId)
ORDER BY timestamp ASC;